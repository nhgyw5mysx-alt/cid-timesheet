<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TimeLatch</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TimeLatch">
<link rel="apple-touch-icon" href="IMG_2776.jpeg">
<link rel="manifest" href="data:application/manifest+json,{"name":"TimeLatch","short_name":"TimeLatch","start_url":".","display":"standalone","background_color":"#0a0e1a","theme_color":"#00d4ff","icons":[{"src":"IMG_2776.jpeg","sizes":"192x192","type":"image/jpeg"}]}">

<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0e1a;color:white;min-height:100vh;overflow-x:hidden;position:relative}
canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
.app{max-width:500px;margin:0 auto;position:relative;z-index:1;padding:20px 16px 160px}

#offline-banner{position:fixed;top:0;left:0;right:0;background:#ff3b5c;color:white;text-align:center;padding:10px;font-size:14px;z-index:999;transform:translateY(-100%);transition:transform .3s}
#offline-banner.show{transform:translateY(0)}

#install-modal{position:fixed;inset:0;background:rgba(10,14,26,0.98);backdrop-filter:blur(12px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;visibility:hidden;transition:opacity .4s}
#install-modal.show{opacity:1;visibility:visible}
.modal-content{background:#0f1629;border-radius:32px;padding:40px 30px;text-align:center;max-width:380px;width:100%;box-shadow:0 20px 60px rgba(0,212,255,0.3)}
.modal-content img{width:110px;height:110px;border-radius:24px;box-shadow:0 0 40px rgba(0,212,255,0.6);margin-bottom:20px}
.modal-content h2{font-family:'Exo 2',sans-serif;font-size:36px;margin:16px 0;background:linear-gradient(90deg,#00d4ff,#00aaff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#install-btn{background:linear-gradient(135deg,#00ff9d,#00d4ff);color:#000;font-size:22px;font-weight:bold;padding:20px;border:none;border-radius:28px;width:100%;cursor:pointer}
#close-install{color:#888;margin-top:20px;background:none;border:none;cursor:pointer}

.header{text-align:center;margin-bottom:32px}
.logo-img{width:90px;border-radius:18px;box-shadow:0 0 28px rgba(0,212,255,0.5);animation:pulse 3s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(0,212,255,0.4)}50%{box-shadow:0 0 38px rgba(0,212,255,0.7)}}
h1{font-family:'Exo 2',sans-serif;font-size:40px;font-weight:700;background:linear-gradient(90deg,#00d4ff,#00aaff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-top:12px}
.today-date{font-family:'Exo 2',font-size:28px;color:#00d4ff;text-align:center;margin:24px 0 32px;text-shadow:0 0 10px rgba(0,212,255,0.4)}
.section{margin-bottom:28px}.section-title{font-size:26px;color:#00d4ff;text-align:center;margin:16px 0 20px;font-weight:700}
input,textarea,select{width:100%;padding:18px;background:rgba(255,255,255,0.08);border:1px solid rgba(0,212,255,0.25);border-radius:20px;color:white;font-size:18px;margin:12px 0}
textarea{height:160px;resize:none}
.time-inputs{display:flex;gap:12px;margin:20px 0;justify-content:center;align-items:center}
.time-field{flex:1;text-align:center}
.time-field > div{font-size:16px;color:#00d4ff;margin-bottom:8px;font-weight:600}
.time-box{background:rgba(20,26,46,0.7);border:1px solid rgba(0,212,255,0.3);border-radius:18px;height:56px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.time-box input{font-size:18px;font-weight:bold;color:white;background:transparent;border:none;text-align:center;width:100%;-webkit-appearance:none}
.day{background:rgba(20,26,46,0.9);border-radius:18px;padding:18px;margin:14px 0;border:1px solid rgba(0,212,255,0.3);cursor:pointer;transition:transform .2s}
.day:hover{transform:translateY(-3px)}
.day-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.day-header button{background:#ff3b5c;padding:8px 14px;border-radius:12px;font-size:14px;font-weight:bold;color:white;border:none;cursor:pointer}
pre{background:rgba(0,0,0,0.3);padding:14px;border-radius:14px;white-space:pre-wrap;font-size:17px;line-height:1.6;margin-top:10px}
.ot{color:#00ff9d;font-weight:bold}
button{width:100%;padding:20px;background:#00d4ff;color:#0a0e1a;border:none;border-radius:22px;font-size:22px;font-weight:bold;margin:16px 0;cursor:pointer}
.export-pdf{background:linear-gradient(135deg,#00ff9d,#00d4ff);padding:24px;font-size:26px;border-radius:30px}
.delete-all{background:#ff3b5c;color:white;padding:24px;font-size:26px}
#toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(0,212,255,0.95);color:#000;padding:16px 32px;border-radius:50px;font-weight:bold;z-index:9999;opacity:0;transition:opacity .4s}
.checkbox-wrapper {display:flex;align-items:center;justify-content:center;margin:15px 0;font-size:18px;}
.checkbox-wrapper input {width:24px;height:24px;margin-right:12px;accent-color:#00d4ff;}
.total-earnings {font-size:20px;font-weight:bold;color:#00ff9d;text-align:center;margin:20px 0;padding:15px;background:rgba(0,255,157,0.1);border-radius:16px;border:1px solid rgba(0,255,157,0.3);}
</style>
</head>
<body>
<div id="offline-banner">OFFLINE — Still works perfectly</div>
<canvas id="particles"></canvas>

<div id="install-modal">
  <div class="modal-content">
    <img src="IMG_2776.jpeg" alt="TimeLatch">
    <h2>TimeLatch</h2>
    <p>Works 100% offline • No ads • Forever free</p>
    <button id="install-btn">Add to Home Screen</button>
    <button id="close-install">Maybe later</button>
  </div>
</div>

<div class="app">
  <div class="header"><img src="IMG_2776.jpeg" alt="Logo" class="logo-img"><h1>TimeLatch</h1></div>
  <div class="today-date" id="today-date"></div>

  <div class="section"><div class="section-title">Your Name</div><input type="text" id="user-name" placeholder="e.g. Daniel"></div>

  <div class="section">
    <div class="section-title">Hourly Rate</div>
    <input type="number" id="hourly-rate" placeholder="e.g. 45.50" step="0.01" min="0">
  </div>
  
  <div class="section">
    <div class="time-inputs">
      <div class="time-field"><div>DAY</div><div class="time-box"><input type="date" id="entry-date"></div></div>
      <div class="time-field"><div>START</div><div class="time-box"><input type="time" id="start-time" value="06:00"></div></div>
      <div class="time-field"><div>FINISH</div><div class="time-box"><input type="time" id="finish-time" value="18:00"></div></div>
    </div>
    <div class="checkbox-wrapper">
      <input type="checkbox" id="twelve-hour-mode">
      <label for="twelve-hour-mode">12-hour shift pattern (6am-6pm / 6pm-6am)</label>
    </div>
  </div>

  <div class="section"><div class="section-title">Job Location</div>
    <div class="job-location-wrapper">
      <select id="job">
        <option value="CSL Broadmeadows">CSL Broadmeadows</option>
        <option value="CSL Tullamarine">CSL Tullamarine</option>
        <option value="CSL Melbourne">CSL Melbourne</option>
        <option value="other">+ Add New Location</option>
      </select>
    </div>
  </div>

  <div class="section"><div class="section-title">Notes</div><textarea id="notes" placeholder="Type everything here…"></textarea><button id="add-btn">ADD ENTRY</button></div>
  <div class="section"><div class="section-title">Your Week So Far</div><div id="output"></div></div>
  
  <button class="export-pdf" onclick="exportPDF()">Export PDF Timesheet</button>
  <button class="delete-all" onclick="deleteAll()">DELETE ALL ENTRIES</button>
</div>

<div id="toast"></div>

<script>
// Today's date (Melbourne time)
const now = new Date();
const melb = {timeZone: 'Australia/Melbourne'};
document.getElementById('today-date').innerText = now.toLocaleDateString('en-AU', {...melb, weekday:'long', day:'numeric', month:'long', year:'numeric'});
document.getElementById('entry-date').value = now.toISOString().split('T')[0];

// Load saved data
let week = JSON.parse(localStorage.getItem('timelatch_week') || '{}');
let customJobs = JSON.parse(localStorage.getItem('timelatch_jobs') || '[]');
let hourlyRate = parseFloat(localStorage.getItem('timelatch_rate')) || 0;
document.getElementById('hourly-rate').value = hourlyRate || '';
let editing = null;
const wrapper = document.querySelector('.job-location-wrapper');
const toast = document.getElementById('toast');
const addBtn = document.getElementById('add-btn');
const twelveMode = document.getElementById('twelve-hour-mode');

// Save rate on change
document.getElementById('hourly-rate').addEventListener('input', e => {
  hourlyRate = parseFloat(e.target.value) || 0;
  localStorage.setItem('timelatch_rate', hourlyRate);
  render(); // refresh earnings display
});

// Restore saved name
if (localStorage.getItem('timelatch_name')) {
  document.getElementById('user-name').value = localStorage.getItem('timelatch_name');
}

function showToast(msg) {
  toast.textContent = msg;
  toast.style.opacity = 1;
  setTimeout(() => toast.style.opacity = 0, 3000);
}

function save() { localStorage.setItem('timelatch_week', JSON.stringify(week)); }
function saveJobs() { localStorage.setItem('timelatch_jobs', JSON.stringify(customJobs)); renderJobs(); }
function saveName() {
  const n = document.getElementById('user-name').value.trim();
  if (n) localStorage.setItem('timelatch_name', n);
}

function timeToMins(t) {
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function updateFinishTime(start) {
  const [h, m] = start.split(':').map(Number);
  let endH = (h + 12) % 24;
  const endTime = `${endH.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
  document.getElementById('finish-time').value = endTime;
}

twelveMode.addEventListener('change', () => {
  if (twelveMode.checked) {
    const start = document.getElementById('start-time').value;
    if (start) updateFinishTime(start);
  }
});

document.getElementById('start-time').addEventListener('change', e => {
  if (twelveMode.checked && e.target.value) updateFinishTime(e.target.value);
});

function submitEntry() {
  saveName();
  const job = document.getElementById('job').value.trim();
  const notes = document.getElementById('notes').value.trim();
  const date = document.getElementById('entry-date').value;
  let start = document.getElementById('start-time').value || "06:00";
  let finish = document.getElementById('finish-time').value || "18:00";
  const is12hr = twelveMode.checked;

  if (!notes || !date) return alert("Please fill notes and date!");

  const dayObj = new Date(date);
  const weekday = dayObj.getDay();
  const isSaturday = weekday === 6;
  const isSunday = weekday === 0;
  const isWeekday = weekday >= 1 && weekday <= 5;

  const sM = timeToMins(start);
  const fM = timeToMins(finish);
  let hoursWorked = ((fM >= sM ? fM - sM : fM - sM + 1440) / 60).toFixed(2);

  let otLabel = '';

  if (is12hr) {
    if (Math.abs(parseFloat(hoursWorked) - 12) > 1) {
      showToast("Adjusted finish to 12-hour shift");
      updateFinishTime(start);
      finish = document.getElementById('finish-time').value;
      hoursWorked = '12.00';
    }

    const isNight = sM >= timeToMins('18:00');

    if (isWeekday) {
      if (isNight) {
        otLabel = '3.5 OT + 8.5 OTT';
      } else {
        otLabel = '8 normal + 4 OT';
      }
    } else if (isSaturday) {
      otLabel = 'all OT';
    } else {
      otLabel = 'all OTT';
    }
  } else {
    let normal = 0;
    let ot = 0;

    if (isSaturday || isSunday) {
      ot = parseFloat(hoursWorked);
    } else {
      const dayStartMins = 7 * 60;
      const dayEndMins   = 15.5 * 60;
      const beforeOT = Math.max(0, Math.min(fM, dayStartMins) - sM) / 60;
      const afterOT  = Math.max(0, fM - Math.max(sM, dayEndMins)) / 60;
      const totalOT  = beforeOT + afterOT;
      const coreHours = Math.max(0, Math.min(fM, dayEndMins) - Math.max(sM, dayStartMins)) / 60;

      ot = totalOT;

      if (totalOT > 0) {
        normal = coreHours;
      } else {
        normal = coreHours > 0 ? coreHours - 0.5 : 0;
      }
    }

    hoursWorked = (normal + ot).toFixed(2);
    otLabel = ot > 0 ? (isSunday ? 'Double Time & Half' : 'OT') : '';
  }

  const entry = {
    times: start + ' – ' + finish,
    paid: hoursWorked,
    otLabel,
    notes,
    job,
    is12hr
  };

  if (editing) {
    const {date: oldDate, index} = editing;
    week[oldDate].splice(index, 1);
    if (week[oldDate]?.length === 0) delete week[oldDate];
    editing = null;
    addBtn.textContent = "ADD ENTRY";
    showToast("Entry updated!");
  } else {
    showToast("Entry added!");
  }

  if (!week[date]) week[date] = [];
  week[date].push(entry);
  save();
  render();
  document.getElementById('notes').value = '';
}
addBtn.onclick = submitEntry;

function editEntry(date, index) {
  event.stopPropagation();
  editing = {date, index};
  const e = week[date][index];
  document.getElementById('entry-date').value = date;
  const [s, f] = e.times.split(' – ');
  document.getElementById('start-time').value = s;
  document.getElementById('finish-time').value = f;
  document.getElementById('notes').value = e.notes;
  twelveMode.checked = !!e.is12hr;
  restoreSelect(e.job);
  addBtn.textContent = "UPDATE ENTRY";
  window.scrollTo(0, 0);
  showToast("Now editing — tap UPDATE when done");
}

function deleteEntry(date, index) {
  event.stopPropagation();
  if (confirm("Delete this entry?")) {
    week[date].splice(index, 1);
    if (week[date]?.length === 0) delete week[date];
    save();
    render();
    showToast("Deleted");
  }
}

function deleteAll() {
  if (confirm('Delete EVERYTHING forever?')) {
    week = {};
    localStorage.removeItem('timelatch_week');
    save();
    render();
    showToast("All deleted");
  }
}

function render() {
  let html = '';
  let totalPaidHours = 0;

  Object.keys(week).sort((a,b) => b.localeCompare(a)).forEach(d => {
    const dayObj = new Date(d + 'T12:00');
    const nice = dayObj.toLocaleDateString('en-AU', {weekday:'long', day:'numeric', month:'short'});
    week[d].forEach((e, i) => {
      const paidNum = parseFloat(e.paid) || 0;
      totalPaidHours += paidNum;
      const earnings = paidNum * hourlyRate;
      let hoursDisplay = `${e.paid} hrs`;
      if (e.otLabel) hoursDisplay += ` <span class="ot">(${e.otLabel})</span>`;
      if (hourlyRate > 0) {
        hoursDisplay += ` → $${earnings.toFixed(2)}`;
      }
      html += `<div class="day" onclick="editEntry('${d}', ${i})">
        <div class="day-header"><b>${nice} | ${e.job}</b>
          <button onclick="deleteEntry('${d}', ${i})">Delete</button>
        </div>
        ${e.times} – ${hoursDisplay}
        <pre>${e.notes}</pre>
      </div>`;
    });
  });

  if (Object.keys(week).length > 0 && hourlyRate > 0) {
    const totalEarnings = (totalPaidHours * hourlyRate).toFixed(2);
    html += `<div class="total-earnings">Total earnings this week: $${totalEarnings}</div>`;
  }

  document.getElementById('output').innerHTML = html || '<div style="text-align:center;padding:80px;color:#666">No entries yet</div>';
}

async function exportPDF() {
  saveName();
  const name = document.getElementById('user-name').value.trim() || 'Worker';
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 12;
  let y = margin + 8;

  const colX = [margin + 2, margin + 28, margin + 65, margin + 105, margin + 145];
  const colWidths = [
    colX[1] - colX[0],
    colX[2] - colX[1],
    colX[3] - colX[2],
    colX[4] - colX[3],
    pageWidth - margin - colX[4]
  ];

  function addHeader() {
    pdf.setFontSize(20);
    pdf.text('TimeLatch Timesheet', pageWidth / 2, y, { align: 'center' });
    y += 9;
    pdf.setFontSize(15);
    pdf.text(name, pageWidth / 2, y, { align: 'center' });
    y += 14;

    pdf.setFontSize(11);
    pdf.setFillColor(0, 212, 255);
    pdf.rect(margin, y - 4, pageWidth - 2*margin, 7, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.text('Date', colX[0], y + 1);
    pdf.text('Location', colX[1], y + 1);
    pdf.text('Time', colX[2], y + 1);
    pdf.text('Hours', colX[3], y + 1);
    pdf.text('Notes', colX[4], y + 1);
    pdf.setTextColor(0, 0, 0);
    y += 10;
  }

  addHeader();

  const rows = [];
  Object.keys(week).sort((a,b) => b.localeCompare(a)).forEach(date => {
    const dayObj = new Date(date + 'T12:00');
    const nice = dayObj.toLocaleDateString('en-AU', {weekday:'long', day:'numeric', month:'short'});
    week[date].forEach(e => {
      let hoursText = `${e.paid} hrs`;
      if (e.otLabel) hoursText += ` (${e.otLabel})`;
      rows.push([nice, e.job, e.times, hoursText, e.notes]);
    });
  });

  if (rows.length === 0) {
    pdf.setFontSize(14);
    pdf.text('No entries yet', pageWidth / 2, pageHeight / 2, { align: 'center' });
    pdf.save(`Timesheet_${name}_${now.toISOString().slice(0,10)}.pdf`);
    return;
  }

  pdf.setFontSize(9.5);
  pdf.setLineHeightFactor(1.25);

  rows.forEach(row => {
    const splitRow = row.map((cell, i) => {
      if (i === 3 && cell.length > 30) pdf.setFontSize(8.5);
      else pdf.setFontSize(9.5);
      return pdf.splitTextToSize(cell.toString().replace(/\\n/g, '\n'), colWidths[i]);
    });

    const maxLines = Math.max(...splitRow.map(lines => lines.length));
    const rowHeight = maxLines * 5 + 3;

    if (y + rowHeight > pageHeight - margin - 10) {
      pdf.addPage();
      y = margin + 8;
      addHeader();
    }

    for (let c = 0; c < 5; c++) {
      if (c === 3 && row[c].length > 30) pdf.setFontSize(8.5);
      else pdf.setFontSize(9.5);
      pdf.text(splitRow[c], colX[c], y + 3);
    }

    y += rowHeight;
  });

  pdf.save(`Timesheet_${name}_${now.toISOString().slice(0,10)}.pdf`);
  showToast("PDF exported successfully!");
}

// Job selector
wrapper.addEventListener('change', e => {
  if (e.target.value === 'other') {
    wrapper.innerHTML = `<input type="text" id="job" placeholder="New location…" style="width:100%;padding:18px;background:rgba(255,255,255,0.08);border:1px solid rgba(0,212,255,0.25);border-radius:20px;color:white;font-size:18px">`;
    const input = document.getElementById('job');
    input.focus();
    input.addEventListener('keydown', ev => {
      if (ev.key === 'Enter') {
        const v = input.value.trim();
        if (v && !customJobs.includes(v)) {
          customJobs.unshift(v);
          saveJobs();
        }
        restoreSelect(v || '');
      }
    });
  }
});

function restoreSelect(selected = '') {
  let html = `<select id="job">
    <option value="CSL Broadmeadows">CSL Broadmeadows</option>
    <option value="CSL Tullamarine">CSL Tullamarine</option>
    <option value="CSL Melbourne">CSL Melbourne</option>`;
  customJobs.forEach(j => html += `<option value="${j}">${j}</option>`);
  html += `<option value="other">+ Add New Location</option></select>`;
  wrapper.innerHTML = html;
  if (selected) document.getElementById('job').value = selected;
}

function renderJobs() {
  restoreSelect(document.getElementById('job')?.value || '');
}

render();
renderJobs();
</script>
</body>
</html>