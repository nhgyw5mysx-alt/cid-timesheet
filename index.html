<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TimeLatch</title>

  <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@600;700&display=swap" rel="stylesheet">

  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #0a0e1a;
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      padding: 20px 16px;
    }

    canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    .app {
      max-width: 500px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }
    .logo-img {
      width: 90px;
      height: auto;
      border-radius: 18px;
      margin: 8px auto;
      box-shadow: 0 0 28px rgba(0,212,255,0.5);
      animation: pulse 3s infinite ease-in-out;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(0,212,255,0.4); }
      50% { box-shadow: 0 0 38px rgba(0,212,255,0.7); }
    }
    h1 {
      font-family: 'Exo 2', sans-serif;
      font-size: 40px;
      font-weight: 700;
      background: linear-gradient(90deg, #00d4ff, #00aaff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 12px;
      text-shadow: 0 0 12px rgba(0,212,255,0.3);
    }

    .today-date {
      font-family: 'Exo 2', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: #00d4ff;
      text-align: center;
      margin: 24px 0 32px;
      text-shadow: 0 0 10px rgba(0,212,255,0.4);
    }

    .section {
      margin-bottom: 28px;
      padding: 0 8px;
    }

    .section-title {
      font-size: 26px;
      color: #00d4ff;
      text-align: center;
      margin: 16px 0 20px;
      font-weight: 700;
    }

    #user-name {
      width: 100%;
      padding: 18px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(0,212,255,0.25);
      border-radius: 20px;
      color: white;
      font-size: 18px;
      text-align: center;
    }

    .time-inputs {
      display: flex;
      gap: 18px;
      margin: 20px 0;
      justify-content: center;
    }
    .time-field {
      flex: 1;
      max-width: 135px;
      text-align: center;
    }
    .time-field > div {
      font-size: 17px;
      color: #00d4ff;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .time-box {
      background: rgba(20, 26, 46, 0.7);
      border: 1px solid rgba(0,212,255,0.3);
      border-radius: 18px;
      padding: 10px 4px;
      backdrop-filter: blur(8px);
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .time-box input {
      background: transparent;
      border: none;
      color: white;
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      width: 100%;
      outline: none;
      letter-spacing: -0.5px;
    }

    /* JOB LOCATION – FULL LIST ALWAYS VISIBLE */
    .job-location-wrapper {
      position: relative;
    }
    #job {
      width: 100%;
      padding: 18px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(0,212,255,0.25);
      border-radius: 20px;
      color: white;
      font-size: 18px;
      margin: 12px 0;
      appearance: none;
      -webkit-appearance: none;
    }
    #job.custom-input {
      color: white;
      font-style: normal;
    }
    #job.custom-input::placeholder {
      color: #aaa;
    }

    textarea, #output {
      width: 100%;
      padding: 18px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(0,212,255,0.25);
      border-radius: 20px;
      color: white;
      font-size: 18px;
      margin: 12px 0;
    }
    textarea {
      height: 160px;
      resize: none;
    }

    .day {
      background: rgba(20, 26, 46, 0.85);
      border-radius: 18px;
      padding: 18px;
      margin: 14px 0;
      border: 1px solid rgba(0,212,255,0.2);
    }
    pre {
      background: rgba(0,0,0,0.3);
      padding: 14px;
      border-radius: 14px;
      white-space: pre-wrap;
      font-size: 17px;
      margin: 10px 0;
      line-height: 1.6;
      max-height: 180px;
      overflow-y: auto;
    }
    .ot { color: #00ff9d; font-weight: bold; text-shadow: 0 0 6px rgba(0,255,157,0.5); }

    button {
      width: 100%;
      padding: 20px;
      background: #00d4ff;
      color: #0a0e1a;
      border: none;
      border-radius: 22px;
      font-size: 22px;
      font-weight: bold;
      margin: 16px 0;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,212,255,0.3);
      transition: 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,212,255,0.4);
    }
    .export-pdf { 
      background: linear-gradient(135deg, #00ff9d, #00d4ff); 
      padding: 24px; 
      font-size: 26px; 
      border-radius: 30px;
      box-shadow: 0 8px 24px rgba(0,212,255,0.4);
    }
    .delete-all { background: #ff3b5c; color: white; padding: 24px; font-size: 26px; }

    /* PDF TEMPLATE */
    #pdf-template {
      position: absolute;
      left: -9999px;
      top: 0;
      width: 800px;
      padding: 60px;
      background: white;
      color: #000;
      font-family: 'Helvetica', sans-serif;
    }
    #pdf-template .header {
      text-align: center;
      margin-bottom: 40px;
    }
    #pdf-template .logo {
      width: 80px;
      border-radius: 16px;
      margin-bottom: 16px;
    }
    #pdf-template h1 {
      font-size: 36px;
      background: linear-gradient(90deg, #00d4ff, #00aaff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }
    #pdf-template .subtitle {
      font-size: 20px;
      color: #555;
      margin-top: 8px;
    }
    #pdf-template table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      font-size: 16px;
    }
    #pdf-template th, #pdf-template td {
      border: 1px solid #ddd;
      padding: 14px;
      text-align: left;
    }
    #pdf-template th {
      background: linear-gradient(135deg, #00d4ff, #00aaff);
      color: white;
      font-weight: bold;
    }
    #pdf-template .ot {
      color: #00aa00;
      font-weight: bold;
    }
    #pdf-template .notes {
      font-style: italic;
      color: #444;
    }
  </style>
</head>
<body>
  <canvas id="particles"></canvas>

  <div class="app">

    <div class="header">
      <img src="IMG_2776.jpeg" alt="TimeLatch Logo" class="logo-img">
      <h1>TimeLatch</h1>
    </div>

    <div class="today-date" id="today-date"></div>

    <div class="section">
      <div class="section-title">Your Name</div>
      <input type="text" id="user-name" placeholder="e.g. Daniel">
    </div>

    <div class="section">
      <div class="time-inputs">
        <div class="time-field">
          <div>START</div>
          <div class="time-box"><input type="time" id="start-time" value="07:00"></div>
        </div>
        <div class="time-field">
          <div>FINISH</div>
          <div class="time-box"><input type="time" id="finish-time" value="15:30"></div>
        </div>
      </div>
    </div>

    <!-- JOB LOCATION – FULL LIST + ENTER TO ADD -->
    <div class="section">
      <div class="section-title">Job Location</div>
      <div class="job-location-wrapper">
        <select id="job">
          <option value="CSL Broadmeadows">CSL Broadmeadows</option>
          <option value="CSL Tullamarine">CSL Tullamarine</option>
          <option value="CSL Melbourne">CSL Melbourne</option>
          <option value="other">+ Add Custom Location</option>
        </select>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Today's Notes</div>
      <textarea id="notes" placeholder="Type everything here…"></textarea>
      <button id="add-btn">ADD TODAY'S ENTRY</button>
    </div>

    <div class="section">
      <div class="section-title">Your Week So Far</div>
      <div id="output"></div>
    </div>

    <button class="export-pdf" onclick="exportPDF()">Export PDF Timesheet</button>
    <button class="delete-all" onclick="deleteAll()">DELETE ALL ENTRIES</button>

  </div>

  <!-- HIDDEN PDF TEMPLATE -->
  <div id="pdf-template">
    <div class="header">
      <img src="IMG_2776.jpeg" alt="Logo" class="logo">
      <h1>TimeLatch</h1>
      <div class="subtitle" id="pdf-name">Daniel's Timesheet</div>
      <div class="subtitle" id="pdf-week">Week ending Monday 10 November 2025</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Location</th>
          <th>Time</th>
          <th>Hours</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="pdf-body"></tbody>
    </table>
  </div>

  <script>
    // PARTICLES
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const particles = [];
    for (let i = 0; i < 50; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        radius: Math.random() * 1.6 + 1,
        speed: Math.random() * 0.4 + 0.2,
        angle: Math.random() * Math.PI * 2
      });
    }
    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach(p => {
        p.x += Math.cos(p.angle) * p.speed;
        p.y += Math.sin(p.angle) * p.speed;
        if (p.x < 0 || p.x > canvas.width) p.angle = Math.PI - p.angle;
        if (p.y < 0 || p.y > canvas.height) p.angle = -p.angle;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0, 212, 255, 0.5)';
        ctx.fill();
      });
      requestAnimationFrame(animate);
    }
    animate();
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    // APP LOGIC
    const now = new Date();
    const melb = { timeZone: 'Australia/Melbourne' };
    document.getElementById('today-date').innerText = now.toLocaleDateString('en-AU', {
      ...melb, weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
    });
    const today = now.toLocaleDateString('en-CA', melb);

    const lastMonday = new Date(now);
    lastMonday.setDate(now.getDate() - ((now.getDay() + 6) % 7));
    const weekEnding = lastMonday.toLocaleDateString('en-AU', {
      ...melb, weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
    });

    let week = JSON.parse(localStorage.getItem('timelatch_week') || '{}');
    let customJobs = JSON.parse(localStorage.getItem('timelatch_jobs') || '[]');

    function save() { localStorage.setItem('timelatch_week', JSON.stringify(week)); }
    function saveJobs() { 
      localStorage.setItem('timelatch_jobs', JSON.stringify(customJobs)); 
      renderJobs();
    }
    function saveName() {
      const name = document.getElementById('user-name').value.trim();
      if (name) localStorage.setItem('timelatch_name', name);
    }

    const jobSelect = document.getElementById('job');
    const wrapper = document.querySelector('.job-location-wrapper');

    // Convert to input on "other"
    jobSelect.addEventListener('change', function () {
      if (this.value === 'other') {
        wrapper.innerHTML = `<input type="text" id="job" class="custom-input" placeholder="Type new location..." autocomplete="off">`;
        const input = document.getElementById('job');
        input.focus();

        // Press Enter to add
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const val = this.value.trim();
            if (!val) return;
            if (!customJobs.includes(val)) {
              customJobs.unshift(val);
              saveJobs();
            }
            restoreSelect(val);
          }
        });

        // Click outside → cancel
        setTimeout(() => {
          document.addEventListener('click', handleOutsideClick);
        }, 0);
      }
    });

    function handleOutsideClick(e) {
      if (!wrapper.contains(e.target)) {
        restoreSelect();
        document.removeEventListener('click', handleOutsideClick);
      }
    }

    function restoreSelect(selected = null) {
      wrapper.innerHTML = `<select id="job">
        <option value="CSL Broadmeadows">CSL Broadmeadows</option>
        <option value="CSL Tullamarine">CSL Tullamarine</option>
        <option value="CSL Melbourne">CSL Melbourne</option>
        <option value="other">+ Add Custom Location</option>
      </select>`;
      renderJobs();
      const newSelect = document.getElementById('job');
      if (selected) newSelect.value = selected;
      newSelect.dispatchEvent(new Event('change'));
    }

    // Render full list
    function renderJobs() {
      const select = document.getElementById('job');
      if (select && select.tagName === 'SELECT') {
        while (select.options.length > 4) select.remove(4);
        customJobs.forEach(job => {
          const opt = new Option(job, job);
          select.add(opt, select.options[select.options.length - 1]);
        });
      }
    }

    function timeToMins(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }

    document.getElementById('add-btn').addEventListener('click', function () {
      saveName();
      let jobElement = document.getElementById('job');
      let job = jobElement.value.trim();

      if (jobElement.tagName === 'INPUT') {
        if (!job) { alert('Type a location!'); return; }
        if (!customJobs.includes(job)) {
          customJobs.unshift(job);
          saveJobs();
        }
      }

      const notes = document.getElementById('notes').value.trim();
      if (!notes) { alert('Add notes!'); return; }

      const start = document.getElementById('start-time').value || "07:00";
      const finish = document.getElementById('finish-time').value || "15:30";
      const startMins = timeToMins(start);
      const finishMins = timeToMins(finish);

      if (week[today]) {
        for (let e of week[today]) {
          const eStart = timeToMins(e.times.split(' – ')[0]);
          const eEnd = timeToMins(e.times.split(' – ')[1]);
          if (startMins < eEnd && finishMins > eStart) {
            alert('TIME CLASH! Already have ' + e.times); return;
          }
        }
      }

      const raw = (finishMins - startMins) / 60;
      const isSat = now.getDay() === 6;
      let normal = 0, ot = 0;
      if (isSat) {
        ot = raw;
      } else {
        const dayStart = 7 * 60;
        const dayEnd = 15.5 * 60;
        const before = Math.max(0, Math.min(finishMins, dayStart) - startMins) / 60;
        const during = Math.max(0, Math.min(finishMins, dayEnd) - Math.max(startMins, dayStart)) / 60;
        const after = Math.max(0, finishMins - Math.max(startMins, dayEnd)) / 60;
        ot = before + after;
        normal = during > 0 ? during - 0.5 : 0;
      }

      const paid = (normal + ot).toFixed(2);
      const entry = { times: start + ' – ' + finish, paid, ot: ot.toFixed(2), notes, job };
      if (!week[today]) week[today] = [];
      week[today].push(entry);
      save(); render();

      if ('vibrate' in navigator) { navigator.vibrate([100, 50, 100]); }

      document.getElementById('notes').value = '';
      restoreSelect(job);
      alert('ENTRY ADDED!');
    });

    function render() {
      let html = '';
      Object.keys(week).sort().reverse().forEach(date => {
        const dayName = new Date(date + 'T12:00:00').toLocaleDateString('en-AU', { ...melb, weekday: 'long', day: 'numeric', month: 'short' });
        week[date].forEach(e => {
          const otTag = e.ot > 0 ? ` <span class="ot">(OT: ${e.ot} hrs)</span>` : '';
          html += `<div class="day">
            <b>${dayName}</b> | ${e.job}<br>
            ${e.times}   <b>${e.paid} hrs</b>${otTag}<pre>${e.notes}</pre>
          </div>`;
        });
      });
      document.getElementById('output').innerHTML = html || '<div style="text-align:center;padding:60px;color:#666;font-size:17px">No entries yet</div>';
    }

    // EXPORT TO PDF
    async function exportPDF() {
      saveName();
      const name = document.getElementById('user-name').value.trim() || 'Employee';
      document.getElementById('pdf-name').innerText = `${name}'s Timesheet`;
      document.getElementById('pdf-week').innerText = `Week ending ${weekEnding}`;

      let rows = '';
      Object.keys(week).sort().reverse().forEach(date => {
        const dayName = new Date(date + 'T12:00:00').toLocaleDateString('en-AU', { ...melb, weekday: 'long', day: 'numeric', month: 'short' });
        week[date].forEach(e => {
          const ot = e.ot > 0 ? `<span class="ot">OT: ${e.ot} hrs</span>` : '';
          rows += `<tr>
            <td>${dayName}</td>
            <td>${e.job}</td>
            <td>${e.times}</td>
            <td>${e.paid} hrs ${ot}</td>
            <td class="notes">${e.notes.replace(/\n/g, '<br>')}</td>
          </tr>`;
        });
      });
      document.getElementById('pdf-body').innerHTML = rows || '<tr><td colspan="5" style="text-align:center;color:#999;">No entries</td></tr>';

      const element = document.getElementById('pdf-template');
      const canvas = await html2canvas(element, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const width = pdf.internal.pageSize.getWidth();
      const height = (canvas.height * width) / canvas.width;
      pdf.addImage(imgData, 'PNG', 0, 0, width, height);
      pdf.save(`Timesheet_${name.replace(' ', '_')}_${weekEnding.replace(/ /g, '_')}.pdf`);
    }

    function deleteAll() {
      if (confirm('DELETE EVERYTHING?')) { week = {}; save(); render(); alert('ALL GONE'); }
    }

    render();
    renderJobs();
  </script>
</body>
</html>